# Media Organizer CLI

This is a Node.js CLI to execute a media organization plan generated by the Media Organizer web UI.

## Installation

```bash
npm install
npm run build
```

## Usage

By default, the CLI runs in **dry run** mode to show you what changes would be made without altering any files. To perform the actual file operations, you must explicitly add the `--execute` flag.

> **Required flags:** `--source-root` and `--dest-root` are mandatory. The CLI will exit with an error if either is missing, because plans reference paths relative to these roots.

### Dry Run (Default)

Run this command to see a preview of the file operations.

```bash
node dist/execute-plan.js --plan ./media-organizer-plan.json --source-root "C:\Users\bassa\Pictures\media" --dest-root "C:\Users\bassa\Pictures\sorted media"
```

### Executing the Plan

To copy the files as specified in the plan, add the `--execute` flag. It is highly recommended to also use `--verify` to ensure file integrity after copying.

```bash
node dist/execute-plan.js --plan ./media-organizer-plan.json --execute --verify --concurrency 6 --resume --source-root "C:\Users\bassa\Pictures\media" --dest-root "C:\Users\bassa\Pictures\sorted media"
```

## Safety

The CLI never deletes files from the source. All operations are copy-only. 

The CLI is designed to be safe by default:
- It will only read files and log intended actions unless `--execute` is specified.
- It will not overwrite existing files at the destination unless you remove the default `--no-overwrite` behavior (not currently possible as it's hardcoded to true).
- It validates that destination paths do not point to locations outside of the specified `--dest-root`, preventing path traversal attacks.

### Options

- `--plan <path>`: **(Required)** Path to the plan JSON file.
- `--execute`: **(Required for changes)** Executes the plan, copying files. Without this flag, the tool will only perform a dry run.
- `--dry-run`: Performs a dry run without changing any files. This is the default behavior if `--execute` is not specified.
- `--source-root <dir>`: **(Required)** The absolute path to the root directory where your source media is located.
- `--dest-root <dir>`: **(Required)** The absolute path to the root directory where you want the media to be organized.
- `--concurrency <n>`: Number of concurrent file operations (default: 4).
- `--verify`: Verifies file integrity by re-hashing after copying.
- `--resume`: Resumes a previous execution, skipping already completed files based on the state log.
- `--duplicates-dir <path>`: Directory to move duplicates to (default: `<destRoot>/duplicates`).
- `--no-overwrite`: If a file already exists at the destination, it will not be overwritten, even if the contents are different. This is on by default.

## Path Resolution

Plans exported by the web app often contain relative source and destination paths. Use the `--source-root` and `--dest-root` flags to specify the absolute paths to the source and destination directories on your local machine.
## Logging

- **Console Output**: The CLI will print progress and status updates to the console.
- **Audit Log**: A detailed audit log is saved to `organizer-execution.log` in JSONL format.
- **State File**: For the `--resume` feature, the CLI creates a `.organizer-state.jsonl` file to keep track of completed operations.

## Interpreting Logs and Resuming

If an execution is interrupted, you can re-run the same command with the `--resume` flag. The CLI will read the `.organizer-state.jsonl` file and skip any files that have already been successfully processed.

The `organizer-execution.log` file contains a detailed record of every operation, including timings, source and destination paths, and file hashes. This can be useful for debugging or for creating custom reports.

## Duplicate Handling

Duplicates are identified by their SHA-256 hash. When a duplicate is found, it is copied to the directory specified by the `--duplicates-dir` option, preserving its original relative path.

## Example Fixture Plan

Here is a small example of a `media-organizer-plan.json` file:

```json
{
  "items": [
    {
      "action": "copy",
      "source": "/path/to/source/IMG_0001.JPG",
      "destination": "/path/to/dest/photo/2023/11/IMG_0001.JPG"
    },
    {
      "action": "copy",
      "source": "/path/to/source/IMG_0002.JPG",
      "destination": "/path/to/dest/photo/2023/11/IMG_0002.JPG"
    },
    {
      "action": "copy",
      "source": "/path/to/source/IMG_0003.JPG",
      "destination": "/path/to/dest/duplicates/photo/2023/11/IMG_0003.JPG"
    }
  ]
}
```

### Expected Console Output

```
[DRY RUN] copy: /path/to/source/IMG_0001.JPG -> /path/to/dest/photo/2023/11/IMG_0001.JPG
[DRY RUN] move: /path/to/source/IMG_0002.JPG -> /path/to/dest/photo/2023/11/IMG_0002.JPG
[DRY RUN] duplicate: /path/to/source/IMG_0003.JPG -> /path/to/dest/duplicates/photo/2023/11/IMG_0003.JPG
Progress: 3/3 | ETA: 0.00s
Execution complete!
Total: 3, Completed: 3, Failed: 0
```
